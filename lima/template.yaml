# Lima VM template for silo
# This template creates a VM with the same tooling as the Docker-based silo
# All tools (claude, opencode, copilot) are installed in a single image

# Use Apple Virtualization Framework (required for macOS)
vmType: vz

# Target ARM64 architecture (same as host)
arch: aarch64

# VM resources - dynamically set based on host
# CPUs: 100% of host CPUs
cpus: {{.CPUs}}
# Memory: 50% of host memory
memory: "{{.Memory}}"
disk: 50GiB

# Use Ubuntu 24.04 as base image
images:
  - location: https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img
    arch: aarch64

# User configuration - match macOS user and paths
user:
  name: {{.User}}
  uid: {{.UID}}
  home: {{.Home}}

# Mount macOS paths into the VM at the same locations
mounts:
{{- range .Mounts}}
  - location: "{{.Source}}"
    mountPoint: "{{.Target}}"
    writable: {{.Writable}}
{{- end}}

# SSH settings
ssh:
  localPort: 0
  loadDotSSHPubKeys: true

# Network configuration - vzNAT provides outbound internet access
networks:
  - vzNAT: true

# Provisioning scripts to install development tools
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Update and install system dependencies
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y \
        ca-certificates \
        build-essential \
        pkg-config \
        libssl-dev \
        curl \
        git \
        unzip \
        zstd \
        jq \
        ncurses-base

      # Install Docker
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      chmod a+r /etc/apt/keyrings/docker.asc
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # Enable Docker service
      systemctl enable docker
      systemctl start docker

  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Add the configured user to the docker group
      usermod -aG docker "{{.User}}"

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Set up environment variables in .bashrc for persistence
      cat >> ~/.bashrc << 'ENVEOF'

      # Silo environment setup
      export GOROOT="$HOME/.local/go"
      export GOPATH="$HOME/go"
      export PATH="$HOME/.claude/bin:$HOME/.opencode/bin:$HOME/.local/bin:$HOME/.local/go/bin:$HOME/go/bin:$HOME/.deno/bin:$HOME/.cargo/bin:$PATH"
      export TERM="xterm-256color"
      ENVEOF

      source ~/.bashrc
      mkdir -p ~/.local ~/.local/bin

      ARCH=$(dpkg --print-architecture)
      ARCH_UNAME=$(uname -m)

      # Download Go, Deno, and gh in parallel
      echo "Downloading tools in parallel..."
      (
        GO_VERSION=$(curl -fsSL https://go.dev/VERSION?m=text | head -1 | sed 's/^go//')
        curl -fsSL -o /tmp/go.tar.gz "https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz"
      ) &
      (
        DENO_VERSION=$(curl -fsSL https://api.github.com/repos/denoland/deno/releases/latest | jq -r '.tag_name | ltrimstr("v")')
        curl -fsSL -o /tmp/deno.zip "https://github.com/denoland/deno/releases/download/v${DENO_VERSION}/deno-${ARCH_UNAME}-unknown-linux-gnu.zip"
      ) &
      (
        GH_VERSION=$(curl -fsSL https://api.github.com/repos/cli/cli/releases/latest | jq -r '.tag_name | ltrimstr("v")')
        curl -fsSL -o /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH}.tar.gz"
      ) &
      wait

      # Extract in parallel
      echo "Extracting tools..."
      tar -C ~/.local -xzf /tmp/go.tar.gz &
      unzip -o /tmp/deno.zip -d ~/.local/bin &
      tar -C ~/.local -xzf /tmp/gh.tar.gz --strip-components=1 &
      wait
      rm -f /tmp/go.tar.gz /tmp/deno.zip /tmp/gh.tar.gz

      # Install Rust (stable + nightly) - runs its own parallel downloads
      echo "Installing Rust..."
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      source "$HOME/.cargo/env"
      rustup toolchain install stable nightly
      rustup target add wasm32v1-none --toolchain stable
      rustup target add wasm32v1-none --toolchain nightly
      rustup component add rust-analyzer

      # Install MCP servers and CLI tools in parallel
      echo "Installing MCP servers and CLI tools..."
      go install golang.org/x/tools/gopls@latest &
      go install github.com/github/github-mcp-server/cmd/github-mcp-server@latest &
      deno install --global --deny-read --allow-env --allow-net npm:server-perplexity-ask &
      deno install --global --allow-env --allow-net --allow-read=$HOME/.cache/deno/npm/registry.npmjs.org/@upstash/context7-mcp npm:@upstash/context7-mcp &
      curl -fsSL https://claude.ai/install.sh | bash &
      curl -fsSL https://opencode.ai/install | bash &
      curl -fsSL https://gh.io/copilot-install | bash &
      wait

      echo "Provisioning complete!"

# Environment variables passed to the VM
env:
  TERM: xterm-256color
